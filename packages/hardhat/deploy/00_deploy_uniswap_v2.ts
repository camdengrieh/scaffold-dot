import { HardhatRuntimeEnvironment } from "hardhat/types";
import { DeployFunction } from "hardhat-deploy/types";
import { Contract } from "ethers";

/**
 * Main deployment script for Uniswap V2 contracts and TokenFactory
 * Deploys the complete Uniswap V2 suite plus token creation capabilities
 *
 * @param hre HardhatRuntimeEnvironment object.
 */
const deployUniswapV2: DeployFunction = async function (hre: HardhatRuntimeEnvironment) {
  const { deployer } = await hre.getNamedAccounts();
  const { deploy } = hre.deployments;

  console.log("\nðŸ¦„ Deploying Uniswap V2 + Token Factory contracts...\n");

  // Known WETH addresses for different networks
  const WETH_ADDRESSES: { [key: string]: string } = {
    // Passet Hub (Custom network) - will deploy mock WETH
    "420420421": "0x0000000000000000000000000000000000000000",
  };

  const chainId = await hre.getChainId();
  let wethAddress = WETH_ADDRESSES[chainId];

  // Deploy mock WETH if not available on this network
  if (!wethAddress || wethAddress === "0x0000000000000000000000000000000000000000") {
    console.log("ðŸ“¦ Deploying Mock WETH contract...");
    const mockWeth = await deploy("MockWETH", {
      from: deployer,
      args: [],
      log: true,
      autoMine: true,
      contract: {
        abi: [
          "function name() public pure returns (string memory)",
          "function symbol() public pure returns (string memory)",
          "function decimals() public pure returns (uint8)",
          "function balanceOf(address) public view returns (uint256)",
          "function transfer(address to, uint256 value) public returns (bool)",
          "function allowance(address owner, address spender) public view returns (uint256)",
          "function approve(address spender, uint256 value) public returns (bool)",
          "function transferFrom(address from, address to, uint256 value) public returns (bool)",
          "function deposit() public payable",
          "function withdraw(uint256 wad) public",
          "event Transfer(address indexed from, address indexed to, uint256 value)",
          "event Approval(address indexed owner, address indexed spender, uint256 value)",
          "event Deposit(address indexed dst, uint256 wad)",
          "event Withdrawal(address indexed src, uint256 wad)",
        ],
        bytecode:
          "0x60806040523480156200001157600080fd5b506040518060400160405280600d81526020017f57726170706564204574686572000000000000000000000000000000000000008152506040518060400160405280600481526020017f5745544800000000000000000000000000000000000000000000000000000000815250816003908162000091919062000284565b508060049081620000a3919062000284565b5050506200036b565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200012c57607f821691505b602082108103620001425762000141620000e4565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620001ac7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200016d565b620001b886836200016d565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600062000205620001ff620001f984620001d0565b620001da565b620001d0565b9050919050565b6000819050919050565b6200022183620001e4565b620002396200023082620002c565b8484546200017a565b825550505050565b600090565b6200025062000241565b6200025d81848462000216565b505050565b5b8181101562000285576200027960008262000246565b60018101905062000263565b5050565b601f821115620002d4576200029e8162000148565b620002a9846200015d565b81016020851015620002b9578190505b620002d1620002c8856200015d56b8355505b505050565b600082821c905092915050565b6000620002f960001984600802620002d9565b1980831691505092915050565b6000620003148383620002e6565b9150826002028217905092915050565b6200032f82620000aa565b67ffffffffffffffff8111156200034b576200034a620000b5565b5b62000357825462000113565b620003648282856200027b565b600060209050601f8311600181146200039c576000841562000387578287015190505b6200039385826200030656b8355062000403565b601f198416620003ac8662000148565b60005b82811015620003d657848901518255600182019150602085019450602081019050620003af565b86831015620003f65784890151620003f2601f891682620002e656b8355505b60016002880201885550505b505050505050565b6109ab806200041b6000396000f3fe6080604052600436106100a05760003560e01c80633ccfd60b116100645780633ccfd60b1461017957806370a08231146101905780638da5cb5b146101cd57806395d89b41146101f8578063a9059cbb14610223578063dd62ed3e14610260576100af565b806306fdde03146100b4578063095ea7b3146100df57806318160ddd1461011c57806323b872dd14610147578063313ce56714610184576100af565b366100af576100ad61029d565b005b600080fd5b3480156100c057600080fd5b506100c9610377565b6040516100d691906106c0565b60405180910390f35b3480156100eb57600080fd5b5061010660048036038101906101019190610770565b610409565b60405161011391906107cb565b60405180910390f35b34801561012857600080fd5b506101316104fb565b60405161013e91906107f5565b60405180910390f35b34801561015357600080fd5b5061016e60048036038101906101699190610810565b610505565b60405161017b91906107cb565b60405180910390f35b34801561019057600080fd5b5061019961063e565b6040516101a6919061087f565b60405180910390f35b34801561019c57600080fd5b506101b760048036038101906101b2919061089a565b610647565b6040516101c491906107f5565b60405180910390f35b3480156101d957600080fd5b506101e261065f565b6040516101ef91906108d6565b60405180910390f35b34801561020457600080fd5b5061020d610669565b6040516101a91906106c0565b60405180910390f35b34801561022f57600080fd5b5061024a60048036038101906102459190610770565b6106fb565b60405161025791906107cb565b60405180910390f35b34801561026c57600080fd5b50610287600480360381019061028291906108f1565b610712565b60405161029491906107f5565b60405180910390f35b346000808282546102ae919061095c565b92505081905550346000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055503373ffffffffffffffffffffffffffffffffffffffff167fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c3460405161034b91906107f5565b60405180910390a2565b606060038054610386906109bf565b80601f01602080910402602001604051908101604052809291908181526020018280546103b2906109bf565b80156103ff5780601f106103d4576101008083540402835291602001916103ff565b820191906000526020600020905b8154815290600101906020018083116103e257829003601f168201915b5050505050905090565b600081600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516104e991906107f5565b60405180910390a36001905092915050565b6000600254905090565b6000600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050828110156105d2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105c990610a3c565b60405180910390fd5b8281036001600086508152602001908152602001600020600083815260200190815260200160002082020391503073ffffffffffffffffffffffffffffffffffffffff16856106219190610770565b506001905093925050505050565b60006012905090565b60006020528060005260406000206000915090505481565b6000600061066c919050919050565b606060048054610678906109bf565b80601f01602080910402602001604051908101604052809291908181526020018280546106a4906109bf565b80156106f15780601f106106c6576101008083540402835291602001916106f1565b820191906000526020600020905b8154815290600101906020018083116106d457829003601f168201915b5050505050905090565b6000610708338484610737565b6001905092915050565b6001602052816000526040600020602052806000526040600020600091509150505481565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036107a6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161079d90610aa8565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610815576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161080c90610b14565b60405180910390fd5b6000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205481111561085f57600080fd5b806000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825403925050819055508060008084815260200190815260200160002060008282540192505081905550508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161092d91906107f5565b60405180910390a3505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061096782610740565b915061097283610740565b925082820190508083111561098a5761098961093a565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806109d757607f821691505b6020821081036109ea576109e9610990565b5b50919050565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206160008201527f6c6c6f77616e6365000000000000000000000000000000000000000000000000602082015250565b6000610a4c602883610650565b9150610a57826109f0565b604082019050919050565b60006020820190508181036000830152610a7b81610a3f565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000610ade602583610650565b9150610ae982610a82565b604082019050919050565b60006020820190508181036000830152610b0d81610ad1565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b6000610b70602383610650565b9150610b7b82610b14565b604082019050919050565b60006020820190508181036000830152610b9f81610b63565b905091905056fea2646970667358221220f7a8cc5b9ff9f65dcee82ec97b6b2b6c9b8d0ad8eee96dc93fae7a4a5b7a77e864736f6c63430008120033",
      },
    });

    wethAddress = mockWeth.address;
    console.log(`âœ… Mock WETH deployed at: ${wethAddress}\n`);
  } else {
    console.log(`âœ… Using existing WETH at: ${wethAddress}\n`);
  }

  // 1. Deploy UniswapV2Factory
  console.log("ðŸ“¦ Deploying UniswapV2Factory...");
  const factory = await deploy("UniswapV2Factory", {
    from: deployer,
    // feeToSetter is set to the deployer initially
    args: [deployer],
    log: true,
    autoMine: true,
  });

  console.log(`âœ… UniswapV2Factory deployed at: ${factory.address}\n`);

  // 2. Deploy UniswapV2Router
  console.log("ðŸ“¦ Deploying UniswapV2Router...");
  const router = await deploy("UniswapV2Router", {
    from: deployer,
    // Router needs factory address and WETH address
    args: [factory.address, wethAddress],
    log: true,
    autoMine: true,
  });

  console.log(`âœ… UniswapV2Router deployed at: ${router.address}\n`);

  // 3. Deploy TokenFactory
  console.log("ðŸ“¦ Deploying TokenFactory...");
  const tokenFactory = await deploy("TokenFactory", {
    from: deployer,
    args: [],
    log: true,
    autoMine: true,
  });

  console.log(`âœ… TokenFactory deployed at: ${tokenFactory.address}\n`);

  // Get deployed contracts for interaction
  const factoryContract = await hre.ethers.getContract<Contract>("UniswapV2Factory", deployer);

  // Display deployment summary
  console.log("ðŸŽ‰ Uniswap V2 + Token Factory Deployment Summary:");
  console.log("=================================================");
  console.log(`WETH Address: ${wethAddress}`);
  console.log(`UniswapV2Factory Address: ${factory.address}`);
  console.log(`UniswapV2Router Address: ${router.address}`);
  console.log(`TokenFactory Address: ${tokenFactory.address}`);
  console.log(`Fee To Setter: ${deployer}`);

  // Get the PAIR_HASH from factory for frontend integration
  try {
    const pairHash = await factoryContract.PAIR_HASH();
    console.log(`Pair Init Code Hash: ${pairHash}`);
  } catch {
    console.log("Note: Could not retrieve PAIR_HASH");
  }

  console.log("\nðŸ“š Next steps:");
  console.log("1. Create custom tokens using the TokenFactory");
  console.log("2. Use the Router to create pairs and add liquidity");
  console.log("3. Perform swaps between your custom tokens");
  console.log("4. Build a frontend DEX interface");
  console.log("5. Monitor all activity through the Block Explorer\n");
};

export default deployUniswapV2;

// Tags are useful if you have multiple deploy files and only want to run one of them.
// e.g. yarn deploy --tags UniswapV2
deployUniswapV2.tags = ["UniswapV2", "TokenFactory", "Factory", "Router"];
